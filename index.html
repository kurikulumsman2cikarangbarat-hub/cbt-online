<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Online</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
        .container { max-width: 800px; background: white; padding: 20px; margin: auto; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .question { margin-bottom: 20px; display: none; }
        .question.active { display: block; }
        .options { list-style: none; padding: 0; }
        .options li { margin: 10px 0; padding: 10px; border: 1px solid #ddd; cursor: pointer; border-radius: 5px; }
        .options li:hover { background: #e9e9e9; }
        .options li.selected { background: #d1e7dd; border-color: #0f5132; }
        .btn { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; }
        .btn:disabled { background: #ccc; }
    </style>
</head>
<body>

<div class="container" id="app">
    <div id="setup-area">
        <h2>Pendaftaran Ujian</h2>
        <input type="text" id="nama_siswa" placeholder="Nama Lengkap"><br><br>
        <input type="text" id="id_kelas" placeholder="Kelas (Contoh: 10-A)"><br><br>
        <button class="btn" onclick="startExam()">Mulai Ujian</button>
    </div>

    <div id="quiz-area" style="display:none;">
        <div id="timer">Sisa Waktu: <span id="time">00:00</span></div>
        <hr>
        <div id="question-container"></div>
        <button class="btn" id="prevBtn" onclick="changeQuestion(-1)">Kembali</button>
        <button class="btn" id="nextBtn" onclick="changeQuestion(1)">Lanjut</button>
        <button class="btn" id="submitBtn" style="display:none; background: #28a745;" onclick="submitExam()">Selesai & Kirim</button>
    </div>
</div>

<script>
    const WORKER_URL = "https://URL-WORKER-ANDA.workers.dev"; // Ganti dengan URL Worker Anda
    let questions = [];
    let currentIdx = 0;
    let userAnswers = {};
    let startTime;

    async function startExam() {
        const nama = document.getElementById('nama_siswa').value;
        if (!nama) return alert("Isi nama dulu!");
        
        startTime = new Date();
        document.getElementById('setup-area').style.display = 'none';
        document.getElementById('quiz-area').style.display = 'block';

        // Ambil soal dari NocoDB via Worker
        try {
            const res = await fetch(`${WORKER_URL}/api/bank_soal?limit=20`);
            const data = await res.json();
            questions = data.list; // NocoDB mengembalikan array di properti 'list'
            renderQuestions();
        } catch (err) {
            alert("Gagal mengambil soal");
        }
    }

    function renderQuestions() {
        const container = document.getElementById('question-container');
        container.innerHTML = questions.map((q, index) => `
            <div class="question ${index === 0 ? 'active' : ''}" id="q-${index}">
                <h3>Soal ${index + 1}</h3>
                <p>${q.pertanyaan}</p>
                <ul class="options">
                    <li onclick="selectOption(${index}, 'A', this)">A. ${q.opsi_a}</li>
                    <li onclick="selectOption(${index}, 'B', this)">B. ${q.opsi_b}</li>
                    <li onclick="selectOption(${index}, 'C', this)">C. ${q.opsi_c}</li>
                    <li onclick="selectOption(${index}, 'D', this)">D. ${q.opsi_d}</li>
                </ul>
            </div>
        `).join('');
    }

    function selectOption(qIdx, choice, el) {
        userAnswers[qIdx] = choice;
        const parent = el.parentElement;
        parent.querySelectorAll('li').forEach(li => li.classList.remove('selected'));
        el.classList.add('selected');
    }

    function changeQuestion(step) {
        document.getElementById(`q-${currentIdx}`).classList.remove('active');
        currentIdx += step;
        document.getElementById(`q-${currentIdx}`).classList.add('active');

        document.getElementById('prevBtn').disabled = currentIdx === 0;
        const isLast = currentIdx === questions.length - 1;
        document.getElementById('nextBtn').style.display = isLast ? 'none' : 'inline-block';
        document.getElementById('submitBtn').style.display = isLast ? 'inline-block' : 'none';
    }

    async function submitExam() {
        if (!confirm("Yakin ingin mengakhiri ujian?")) return;

        const endTime = new Date();
        let benar = 0;
        let salah = 0;

        questions.forEach((q, idx) => {
            if (userAnswers[idx] === q.jawaban_benar) benar++;
            else salah++;
        });

        const nilai = (benar / questions.length) * 100;

        // Data yang dikirim ke tabel "nilai" sesuai field yang Anda minta
        const payload = {
            nama_siswa: document.getElementById('nama_siswa').value,
            id_kelas: document.getElementById('id_kelas').value,
            jml_benar: benar,
            jml_salah: salah,
            nilai: nilai,
            jawaban: JSON.stringify(userAnswers),
            wkt_mulai: startTime.toISOString(),
            wkt_selesai: endTime.toISOString(),
            token: "TOKEN-" + Math.random().toString(36).substr(2, 9).toUpperCase()
        };

        try {
            const res = await fetch(`${WORKER_URL}/api/nilai`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (res.ok) {
                alert(`Ujian Selesai! Skor Anda: ${nilai}`);
                location.reload();
            }
        } catch (err) {
            alert("Gagal menyimpan nilai ke database.");
        }
    }
</script>

</body>
</html>