<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CBT SMAN 2 Cikarang Barat</title>
    <style>
        /* CSS TETAP SEPERTI ASLI ANDA */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
        body { background: #f0f2f5; color: #333; display: flex; justify-content: center; align-items: center; padding: 15px; user-select: none; }
        .container { width: 100%; max-width: 650px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); min-height: 600px; display: flex; flex-direction: column; overflow: hidden; }
        .header { background: #1a73e8; color: white; padding: 25px; text-align: center; }
        .page { padding: 25px; display: none; flex-grow: 1; flex-direction: column; }
        .page.active { display: flex; }
        label { font-weight: 600; display: block; margin-bottom: 8px; color: #444; }
        input, select { width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; margin-bottom: 15px; }
        .btn { width: 100%; padding: 16px; background: #1a73e8; color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
        .timer-info { padding: 12px 20px; display: flex; justify-content: space-between; font-weight: bold; color: #1a73e8; background: #e8f0fe; }
        .control-bar { padding: 15px 25px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-between; }
        .btn-circle { width: 50px; height: 50px; border-radius: 50%; border: none; background: #1a73e8; color: white; font-size: 1.5rem; cursor: pointer; }
        .nav-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px; padding: 15px; background: #f8f9fa; max-height: 150px; overflow-y: auto; }
        .nav-box { height: 40px; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; }
        .nav-box.answered { background: #1a73e8; color: white; }
        .nav-box.current { border: 2px solid #f57c00; }
        .option { display: block; width: 100%; padding: 15px; margin-bottom: 12px; background: #fff; border: 2px solid #e0e0e0; border-radius: 12px; text-align: left; cursor: pointer; }
        .option.selected { border-color: #1a73e8; background: #e8f0fe; color: #1a73e8; font-weight: 600; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="container" id="main-container">
    <div id="view-login" class="page active">
        <div class="header" style="margin: -25px -25px 25px -25px;">
            <h2>CBT SMAN 2 Cikarang Barat</h2>
            <p>Lengkapi data untuk memulai</p>
        </div>
        <label>Nama Peserta</label>
        <input type="text" id="input-nama" placeholder="Nama Lengkap..." autocomplete="off">
        <label>Tingkat</label>
        <select id="input-kelas" onchange="filterKelompok()">
            <option value="" disabled selected>-- Pilih Tingkat --</option>
            <option value="X">Kelas X</option>
            <option value="XI">Kelas XI</option>
            <option value="XII">Kelas XII</option>
        </select>
        <label>Kelas</label>
        <select id="input-kelompok"><option value="" disabled selected>-- Pilih Kelas --</option></select>
        <label>Password / Token</label>
        <input type="text" id="input-password" placeholder="Password Ujian" autocomplete="off">
        <button class="btn" onclick="checkExam()">MULAI UJIAN</button>
    </div>

    <div id="view-loading" class="page" style="text-align: center; justify-content: center;">
        <div class="loader"></div>
        <h3>Memproses Data...</h3>
    </div>

    <div id="view-exam" class="page" style="padding: 0;">
        <div class="timer-info">
            <span>Soal <span id="q-number">1</span></span>
            <span id="timer-display" style="color: #d32f2f;">00:00</span>
        </div>
        <div style="padding: 25px; flex-grow: 1; overflow-y: auto;">
            <div id="q-text-display" style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 20px;"></div>
            <div id="q-options-display"></div>
        </div>
        <div class="control-bar">
            <button class="btn-circle" onclick="prevQuestion()">❮</button>
            <button id="btn-submit-exam" class="btn" style="width: auto; padding: 10px 20px; background: #27ae60; display: none;" onclick="finishExam()">KIRIM JAWABAN</button>
            <button class="btn-circle" onclick="nextQuestion()">❯</button>
        </div>
        <div class="nav-grid" id="navigation-grid"></div>
    </div>

    <div id="view-result" class="page" style="text-align: center; justify-content: center;">
        <div style="background: #e8f5e9; padding: 30px; border-radius: 15px; border: 2px solid #4caf50;">
            <span style="font-size: 50px;">✅</span>
            <div id="final-message" style="margin-top: 15px; color: #2e7d32; font-weight: bold;"></div>
        </div>
        <button onclick="location.reload()" class="btn" style="margin-top: 20px; background: #666;">Keluar Aplikasi</button>
    </div>
</div>

<script>
    const API_URL = "https://nocob-proxy.kurikulum-sman2cikarangbarat.workers.dev"; 

    let examData = {
        questions: [],
        currentIndex: 0,
        answers: {}, // Key menggunakan ID Soal agar unik
        student: {},
        startTime: null,
        cheatCount: 0,
        timer: null,
        remainingSeconds: 0
    };

    function filterKelompok() {
        const tingkat = document.getElementById('input-kelas').value;
        const sel = document.getElementById('input-kelompok');
        sel.innerHTML = '<option value="" disabled selected>-- Pilih Kelas --</option>';
        
        let list = [];
        if (tingkat === "X") list = ["X - A", "X - B", "X - C", "X - D", "X - E", "X - F"];
        else if (tingkat === "XI") list = ["XI - A", "XI - B", "XI - C", "XI - D", "XI - E", "XI - F", "XI - G"];
        else if (tingkat === "XII") list = ["XII - A", "XII - B", "XII - C", "XII - D", "XII - E", "XII - F", "XII - G"];
        
        list.forEach(k => {
            let o = document.createElement("option"); o.value = k; o.innerText = k;
            sel.appendChild(o);
        });
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    async function checkExam() {
        const n = document.getElementById('input-nama').value.trim();
        const k = document.getElementById('input-kelas').value;
        const g = document.getElementById('input-kelompok').value;
        const p = document.getElementById('input-password').value.trim();

        if (!n || !k || !g || !p) return alert("Mohon lengkapi seluruh data!");

        showPage('view-loading');

        try {
            const resToken = await fetch(`${API_URL}/api/ujian?where=(token,eq,${p})`);
            const dataToken = await resToken.json();

            if (dataToken.list && dataToken.list.length > 0) {
                const infoUjian = dataToken.list[0];
                const resSoal = await fetch(`${API_URL}/api/bank_soal?where=(token,eq,${p})`);
                const dataSoal = await resSoal.json();

                if (dataSoal.list && dataSoal.list.length > 0) {
                    examData.questions = dataSoal.list.sort(() => Math.random() - 0.5);
                    examData.student = { nama: n, tingkat: k, kelas: g, token: p };
                    examData.startTime = new Date();
                    
                    // Timer Setting (Ambil dari tabel ujian kolom durasi, jika ada)
                    const durasiMenit = parseInt(infoUjian.durasi) || 90;
                    examData.remainingSeconds = durasiMenit * 60;
                    
                    showPage('view-exam');
                    renderQuestion();
                    startTimer();
                } else { throw new Error("Soal belum tersedia untuk token ini."); }
            } else { throw new Error("Token salah atau tidak aktif!"); }
        } catch (e) {
            showPage('view-login');
            alert(e.message);
        }
    }

    function startTimer() {
        if (examData.timer) clearInterval(examData.timer);
        examData.timer = setInterval(() => {
            examData.remainingSeconds--;
            let m = Math.floor(examData.remainingSeconds / 60).toString().padStart(2, '0');
            let s = (examData.remainingSeconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
            if (examData.remainingSeconds <= 0) {
                clearInterval(examData.timer);
                alert("Waktu Habis!");
                finishExam();
            }
        }, 1000);
    }

    function renderQuestion() {
        const q = examData.questions[examData.currentIndex];
        document.getElementById('q-number').innerText = `${examData.currentIndex + 1} / ${examData.questions.length}`;
        document.getElementById('q-text-display').innerText = q.pertanyaan;

        let options = [
            {code: 'A', text: q.opsi_a}, {code: 'B', text: q.opsi_b},
            {code: 'C', text: q.opsi_c}, {code: 'D', text: q.opsi_d}
        ];

        let html = '';
        options.forEach(opt => {
            // FIX: Gunakan q.id (ID unik soal dari NocoDB)
            const isSelected = examData.answers[q.id] === opt.code ? 'selected' : '';
            html += `<div class="option ${isSelected}" onclick="selectAnswer(${q.id}, '${opt.code}')">${opt.code}. ${opt.text}</div>`;
        });
        
        document.getElementById('q-options-display').innerHTML = html;
        document.getElementById('btn-submit-exam').style.display = (examData.currentIndex === examData.questions.length - 1) ? 'block' : 'none';
        renderNav();
    }

    function selectAnswer(questionId, code) {
        examData.answers[questionId] = code; 
        renderQuestion();
    }

    function renderNav() {
        const nav = document.getElementById('navigation-grid');
        nav.innerHTML = examData.questions.map((q, i) => {
            const isAnswered = examData.answers[q.id] ? 'answered' : '';
            const isCurrent = i === examData.currentIndex ? 'current' : '';
            return `<div class="nav-box ${isAnswered} ${isCurrent}" onclick="jumpTo(${i})">${i + 1}</div>`;
        }).join('');
    }

    function jumpTo(i) { examData.currentIndex = i; renderQuestion(); }
    function nextQuestion() { if (examData.currentIndex < examData.questions.length - 1) jumpTo(examData.currentIndex + 1); }
    function prevQuestion() { if (examData.currentIndex > 0) jumpTo(examData.currentIndex - 1); }

    async function finishExam() {
        if (examData.remainingSeconds > 0 && !confirm("Kirim jawaban sekarang?")) return;
        
        clearInterval(examData.timer);
        showPage('view-loading');

        let benar = 0;
        examData.questions.forEach(q => {
            if (examData.answers[q.id] === q.jawaban_benar) benar++;
        });

        const score = Math.round((benar / examData.questions.length) * 100);
        const q0 = examData.questions[0];

        // PAYLOAD CLEAN UNTUK MENGHINDARI ERROR 400
        const payload = {
            nama_siswa: examData.student.nama,
            token: examData.student.token,
            mapel: q0.mapel || "Ujian",
            kelas: examData.student.tingkat,
            id_kelas: examData.student.kelas,
            jml_benar: benar,
            jml_salah: examData.questions.length - benar,
            nilai: score,
            jml_curang: examData.cheatCount,
            nama_guru: q0.nama_guru || "-",
            jawaban: JSON.stringify(examData.answers),
            wkt_mulai: examData.startTime.toISOString(),
            wkt_selesai: new Date().toISOString()
        };

        try {
            const res = await fetch(`${API_URL}/api/nilai`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                document.getElementById('final-message').innerHTML = `Selesai!<br>Skor: ${score}<br>Jawaban berhasil disimpan.`;
                showPage('view-result');
            } else {
                const errData = await res.text();
                throw new Error(`Gagal Simpan: ${errData}`);
            }
        } catch (e) {
            alert("Terjadi kesalahan: " + e.message);
            showPage('view-exam');
            startTimer(); // Hidupkan timer lagi jika gagal kirim
        }
    }

    document.addEventListener("visibilitychange", () => {
        if (document.hidden && document.getElementById('view-exam').classList.contains('active')) {
            examData.cheatCount++;
            alert("Dilarang keluar halaman!");
        }
    });
</script>
</body>
</html>
